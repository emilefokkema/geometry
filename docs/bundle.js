!function(){var n,t,e,o,i,r,u,c,s,a,f,l,p,h,d,m;n=function(){var n=function(n,t,e){return n.minus(t).dot(n.minus(e))<=0},t=function(n,t,e,o){var i=t.minus(n),r=o.minus(e),u=r.cross(i);if(0==u)return null;var c=e.minus(n).matrix(-r.y,r.x,-i.y,i.x).scale(1/u);return n.plus(t.minus(n).scale(c.x))},e=function(e,o,i,r){var u=t(e,o,i,r);if(!u)return null;var c=n(u,e,o),s=n(u,i,o);return c&&s?u:null},o=function(e,o,i,r){var u=t(e,o,i,r);return u&&n(u,i,r)?u:null},i=function(t,e,o,i,r){var c=u(t,e,o,i,r);return null==c?null:n(c,t,e)?c:null},r=function(n,t,e,o,i){var r,u,c=n.minus(e).mod();return t+o<c||t+c<o||o+c<t||0==c?null:t+o==c?n.plus(e.minus(n).unit().scale(t)):(u=(t*t-o*o+c*c)/(2*c*t),r=Math.sqrt(1-u*u)*(0==i?1:-1),n.plus(e.minus(n).unit().scale(t).matrix(u,-r,r,u)))},u=function(n,t,e,o,i){var r,u,c,s=e.minus(n),a=t.minus(n),f=s.dot(a),l=n.plus(a.unit().scale(f/a.mod())),p=l.minus(e).mod();return p<1e-5?e.plus(a.unit().scale(o*(0==i?1:-1))):p>o?null:p==o?l:(u=s.cross(a)>0?1:-1,c=p/o*u,r=Math.sqrt(1-c*c)*(0==i?1:-1),e.plus(l.minus(e).unit().scale(o*u).matrix(c,-r,r,c)))};return{isBetween:n,intersectLines:t,intersectSegments:e,intersectLineAndSegment:o,intersectSegmentAndCircle:i,intersectCircles:r,intersectLineAndCircle:u,reflectPointInLine:function(n,t,e){var o=t.minus(n),i=e.minus(n),r=o.unit().scale(o.dot(i)/o.mod()),u=i.minus(r);return n.plus(r).plus(u.scale(-1))},projectPointOnLine:function(n,t,e){var o=t.minus(n),i=e.minus(n),r=o.unit().scale(o.dot(i)/o.mod());return n.plus(r)},getPointOnAngleBisector:function(n,t,e){var o=n.minus(t),i=e.minus(t),r=o.dot(i),u=o.unit().scale(r/o.mod()),c=(i.minus(u),o.cross(i)),s=r/(o.mod()*i.mod()),a=(1-s)/2,f=1-a,l=Math.sqrt(a),p=Math.sqrt(f)*(c>0?1:-1);return t.plus(o.matrix(p,-l,l,p))}}}(),t=function(){var n=[],t=function(){var t=arguments;n.map(function(n){n.apply(null,t)})};return t.add=function(e){return n.push(e),t},t.remove=function(t){var e;-1!=(e=n.indexOf(t))&&n.splice(e,1)},t},e=function(n,t){var e=function(n,e){return{orig:n,copy:t(n,e)}},o=n.map(e);return{copyOf:function(n){for(var t=0;t<o.length;t++)if(o[t].orig==n)return o[t].copy;return null},originalOf:function(n){for(var t=0;t<o.length;t++)if(o[t].copy==n)return o[t].orig;return null},allCopies:function(){return o.map(function(n){return n.copy})},addFor:function(n){var t=o.filter(function(t){return t.orig==n});return 0==t.length?(newSet=e(n,o.length),o.push(newSet),newSet.copy):t[0].copy},removeFor:function(n){for(var t=-1,e=0;e<o.length;e++)o[e].orig==n&&(t=e);-1!=t&&o.splice(t,1)}}},o=function(){var n={contains:function(n,t){return(n&t)==t},NONE:0,POINT:1,LINE:2,CIRCLE:4,LOCUS:8,SEGMENT:16,ARC:32};return n.ALL=n.POINT|n.LINE|n.CIRCLE|n.LOCUS|n.SEGMENT|n.ARC,n.NOT_LOCUS=n.POINT|n.LINE|n.CIRCLE|n.SEGMENT|n.ARC,n}(),i=function(){var n=function(t,e){if(!(this instanceof n))return new n(t,e);this.x=t,this.y=e};return n.prototype={minus:function(t){return n(this.x-t.x,this.y-t.y)},plus:function(t){return n(this.x+t.x,this.y+t.y)},cross:function(n){return this.x*n.y-this.y*n.x},mod:function(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))},scale:function(t){return n(t*this.x,t*this.y)},unit:function(){return this.scale(1/this.mod())},toString:function(){return"("+this.x+","+this.y+")"},equals:function(n){return this==n||this.x==n.x&&this.y==n.y},matrix:function(t,e,o,i){return n(t*this.x+e*this.y,o*this.x+i*this.y)},dot:function(n){return this.x*n.x+this.y*n.y},argument:function(){if(0==this.x){if(0==this.y)return 0;if(this.y>0)return Math.PI/2;if(this.y<0)return 3*Math.PI/2}var n=Math.atan(this.y/this.x);return this.x>0?this.y<0?2*Math.PI+n:n:this.x<0?Math.PI+n:void 0}},n}(),r=function(){var t=function(n,t,e,o){return{id:o,s1:n,s2:t,calculate:function(){return e(n.getSpecs(),t.getSpecs())}}},e=[{matches:function(n,t){return n.passesFilter(o.LINE)&&t.passesFilter(o.LINE)},makeForShapes:function(e,o){return[t(e,o,function(t,e){return n.intersectLines(t.p1,t.p2,e.p1,e.p2)},0)]}},{matches:function(n,t){return n.passesFilter(o.SEGMENT)&&t.passesFilter(o.SEGMENT)},makeForShapes:function(e,o){return[t(e,o,function(t,e){return n.intersectSegments(t.p1,t.p2,e.p1,e.p2)},0)]}},{matches:function(n,t){return n.passesFilter(o.SEGMENT)&&t.passesFilter(o.LINE)},makeForShapes:function(e,o){return[t(e,o,function(t,e){return n.intersectLineAndSegment(e.p1,e.p2,t.p1,t.p2)},0)]}},{matches:function(n,t){return n.passesFilter(o.CIRCLE)&&t.passesFilter(o.CIRCLE)},makeForShapes:function(e,o){return[0,1].map(function(i){return t(e,o,function(t,e){return n.intersectCircles(t.center,t.r,e.center,e.r,i)},i)})}},{matches:function(n,t){return n.passesFilter(o.LINE)&&t.passesFilter(o.CIRCLE)},makeForShapes:function(e,o){return[0,1].map(function(i){return t(e,o,function(t,e){return n.intersectLineAndCircle(t.p1,t.p2,e.center,e.r,i)},i)})}},{matches:function(n,t){return n.passesFilter(o.SEGMENT)&&t.passesFilter(o.CIRCLE)},makeForShapes:function(e,o){return[0,1].map(function(i){return t(e,o,function(t,e){return n.intersectSegmentAndCircle(t.p1,t.p2,e.center,e.r,i)},i)})}}],r=[],u=function(n,t,e){var o=r.filter(function(e){return e.s1==n&&e.s2==t||e.s2==n&&e.s1==t}),u=o.lastMin(function(n){return(n.calculate()||i(0,0)).minus(e).mod()});return u.calculate()?u:null},c=function(n,t,e){return r.filter(function(e){return e.s1==n&&e.s2==t||e.s2==n&&e.s1==t}).filter(function(n){return n.id==e})[0]},s=function(n,o){for(var i=0;i<e.length;i++){if(e[i].matches(n,o))return void e[i].makeForShapes(n,o).map(function(n){r.push(n)});if(e[i].matches(o,n))return void e[i].makeForShapes(o,n).map(function(n){r.push(n)})}r.push(t(n,o,function(){return null}))},a=function(n){r=r.filter(function(t){return t.s1!=n&&t.s2!=n})};return{getForShapes:u,getForShapesAndId:c,makeForShapes:function(n){for(var t=0;t<n.length;t++)for(var e=t+1;e<n.length;e++)s(n[t],n[e])},removeForShape:a}},u=function(n,t,e){var o=!1;return e?function(){if(!o){var e=arguments;o=!0,n.apply(null,e),setTimeout(function(){o=!1},t)}}:function(){if(!o){var e=arguments;o=!0,setTimeout(function(){n.apply(null,e),o=!1},t)}}},c=makeModule(function(e){var r=function(){return{}},u={},c=function(n){},s=function(n){return i(0,0)},a=function(){},f=function(){var n={useSpecs:c},t=!1;for(var e in u)u.hasOwnProperty(e)&&(n[e]=function(n){return function(){var e=r();u[n].apply(null,arguments),t||p(e,r())}}(e));return n.together=function(e){var o=r();t=!0,e.apply(n,[]),p(o,r()),t=!1},n},l=function(n){return 1/0},p=t(),h=function(n){return o.contains(n,x)},d=!0,m=t(),g=function(){return i(0,0)},v=function(){return""},S=function(n){return[n]},x=o.ALL;this.expose({isAvailable:function(){return d},makeAvailable:function(n){d=n,m(n)},onchangeavailability:function(n){m.add(n)},getSpecs:function(){return r()},getChanger:f,closestPointTo:function(n){return s(n)},repositionPoint:function(n,t,e){return a(n,t,e)},onchange:function(n){p.add(n)},distance:function(n){return l(n)},passesFilter:function(n){return h(n)},movePointAround:function(n){return S(n)},getLabelLocation:function(){return g()},toString:function(){return v()}}),this.extend("arc",function(){var t,a,p,h,d,m,g,y,L,b;c=function(n){t=n.end1||i(0,0),p=n.end2||i(0,0),a=n.middle||i(0,0),m()},m=function(){var e=a.minus(t),o=p.minus(a),i=t.plus(e.scale(.5)),r=a.plus(o.scale(.5)),u=i.plus(e.matrix(0,-1,1,0)),c=r.plus(o.matrix(0,-1,1,0));h=n.intersectLines(i,u,r,c),d=h?t.minus(h).mod():1/0,g=e.dot(o)},L=function(e){if(h){var o=e.minus(h),i=o.mod();return 0==i?null:h.plus(o.scale(d/i))}return n.projectPointOnLine(t,p,e)},y=function(n){if(0==g){var e=t.minus(p).matrix(0,-1,1,0);return n.dot(e)*a.dot(e)>0}var o=L(n);return!!L&&o.minus(t).dot(p.minus(o))*g>0},c(e),v=function(){return"arc("+t.toString()+","+a.toString()+","+p.toString()+")"},l=function(n){return y(n)?Math.abs(d-n.minus(h).mod()):Math.min(n.minus(t).mod(),n.minus(p).mod())},s=function(n){return y(n)?h.plus(n.minus(h).unit().scale(d)):n.minus(t).mod()<n.minus(p).mod()?t:p},u={setEnd1:function(n){t=n,m()},setEnd2:function(n){p=n,m()},setMiddle:function(n){a=n,m()}},x=o.ARC,r=function(){return{end1:t,end2:p,middle:a,center:h,radius:d,innerDot:g}},b=function(){return{from:t.minus(h).argument(),to:p.minus(h).argument(),clockwise:p.minus(t).cross(a.minus(t))<0}},S=function(){var n=b(),t=n.from,e=n.to;if(!n.clockwise){var o=t;t=e,e=o}t>e&&(t-=2*Math.PI);for(var r=[],u=i(1,0).scale(d),c=t;c<=e;c+=.05){var s=Math.cos(c),a=Math.sin(c);r.push(h.plus(u.matrix(s,-a,a,s)))}return r},this.expose({changer:f(),getAngles:b})}),this.extend("circle",function(){var n,t;c=function(e){n=e.center||i(0,0),t=e.r||1},c(e),v=function(){return"circle("+n.toString()+","+t+")"},l=function(e){return Math.abs(n.minus(e).mod()-t)},s=function(e){return n.plus(e.minus(n).unit().scale(t))},u={setR:function(n){t=n},setCenter:function(t){n=t}},S=function(){var t=Array.apply(null,new Array(101)),e=2*Math.PI/100;return function(o){var i=o.minus(n);return t.map(function(t,o){var r=Math.cos(o*e),u=Math.sin(o*e);return n.plus(i.matrix(r,-u,u,r))})}}(),x=o.CIRCLE,r=function(){return{center:n,r:t}},g=function(){var e=Math.sqrt(2)/2;return n.plus(i(1,0).scale(t+2).matrix(e,e,-e,e))},a=function(n,t,e){return t.r==e.r?n.plus(e.center.minus(t.center)):e.center.plus(n.minus(t.center).scale(e.r/t.r))},this.expose({changer:f()})}),this.extend("line",function(){var t,p;c=function(n){t=n.p1||i(0,0),p=n.p2||i(1,0)},v=function(){return"line("+t.toString()+","+p.toString()+")"},c(e),s=function(e){return n.projectPointOnLine(t,p,e)},l=function(n){return n.minus(s(n)).mod()},r=function(){return{p1:t,p2:p}},u={setP1:function(n){t=n},setP2:function(n){p=n},translateBy:function(n){t=t.plus(n),p=p.plus(n)},moveTo:function(n){p=n.minus(t).dot(p.minus(t))>0?n:t.plus(t.minus(n))},setFromP1:function(n){p=t.plus(n)}},x=o.LINE,a=function(n,t,e){if(t.p1.equals(e.p1)){var o=n.minus(t.p1).dot(t.p2.minus(t.p1))>=0?1:-1;return e.p1.plus(e.p2.minus(e.p1).unit().scale(o*n.minus(e.p1).mod()))}if(!t.p2.equals(e.p2))return n.plus(e.p2.minus(t.p2));var o=n.minus(t.p2).dot(t.p1.minus(t.p2))>=0?1:-1;return e.p2.plus(e.p1.minus(e.p2).unit().scale(o*n.minus(e.p2).mod()))},this.expose({changer:f()})}),this.extend("segment",function(){var t,p;c=function(n){t=n.p1||i(0,0),p=n.p2||i(1,0)},v=function(){return"segment("+t.toString()+","+p.toString()+")"},c(e),s=function(e){var o=p.minus(t),i=e.minus(t).dot(o);return i*e.minus(p).dot(o)<0?n.projectPointOnLine(t,p,e):i>=0?p:t},l=function(n){return n.minus(s(n)).mod()},r=function(){return{p1:t,p2:p}},u={setP1:function(n){t=n},setP2:function(n){p=n},translateBy:function(n){t=t.plus(n),p=p.plus(n)},moveTo:function(n){p=n.minus(t).dot(p.minus(t))>0?n:t.plus(t.minus(n))},setFromP1:function(n){p=t.plus(n)}},S=function(){var n=Array.apply(null,new Array(101));return function(e){var o=p.minus(t).scale(.01);return n.map(function(n,e){return t.plus(o.scale(e))})}}(),x=o.SEGMENT,a=function(n,t,e){if(n.equals(t.p1))return e.p1;if(n.equals(t.p2))return e.p2;var o=n.minus(t.p1).mod()/t.p2.minus(t.p1).mod();return e.p1.plus(e.p2.minus(e.p1).scale(o))},this.expose({changer:f()})}),this.extend("point",function(){var n;c=function(t){n=t.location||i(0,0)},v=function(){return"point"+n.toString()},c(e),l=function(t){return n.minus(t).mod()},s=function(t){return n},x=o.POINT,u={setLocation:function(t){n=t}},r=function(){return{location:n}},g=function(){return n},this.expose({changer:f()})}),this.extend("locus",function(){var n=[],t=[];c=function(n){},l=function(n){return Math.min.apply(null,t.map(function(t){return t.minus(n).mod()}))},v=function(){return"locus()"},s=function(n){return t.lastMin(function(t){return t.minus(n).mod()})},x=o.LOCUS,u={setPointSets:function(e){n=e,t=e.reduce(function(n,t){return n.concat(t)},[])}},r=function(){return{pointSets:n}},this.expose({changer:f()})})}),s=function(n,t){var e=document.body.offsetWidth,o=document.body.offsetHeight,i=[{p1:t(0,0),p2:t(e,0)},{p1:t(e,0),p2:t(e,o)},{p1:t(e,o),p2:t(0,o)},{p1:t(0,o),p2:t(0,0)}],r=function(t,e,o){return n.intersectLines(t,e,o.p1,o.p2)};return function(n,t){return n.x==t.x?{p1:r(n,t,i[0]),p2:r(n,t,i[2])}:{p1:r(n,t,i[1]),p2:r(n,t,i[3])}}}(n,i),a=function(n,t,e,o,i,r,u,c,s){var a,f=document.body.offsetWidth,l=document.body.offsetHeight,p=document.createElement("canvas");p.setAttribute("width",f),p.setAttribute("height",l),document.body.appendChild(p),a=p.getContext("2d");var h=t(),d=t(),m=t(),g=t(),v=t(),S=!1,x=o.ALL,y=function(){var n=100,t=100,e=!0,o="hoi",i=function(e,o){n=e,t=o},r=function(i){e&&(i.fillStyle="#f00",i.font="12px Verdana",i.fillText(o,n,t))};return{setVisible:function(n){e=n},draw:r,setPosition:i,setText:function(n){o=n}}}(),L=makeModule(function(n){var e,o=n.fill||"transparent",i=n.stroke||"black",r=i,s=n.thickness||1.5,a=n.name||"shape",f="",l=!1,p=!1,h=function(n){l?(n.setLineDash([5]),n.strokeStyle="#00f"):(n.setLineDash([]),n.strokeStyle=r),p&&(n.strokeStyle="#bbb"),n.fillStyle=i;var t=e.getLabelLocation();n.font="12px Verdana",n.fillText(f,t.x+5,t.y-5),n.lineWidth=s,n.fillStyle=o},d=function(n){return e.distance(n)<10},m=t().add(function(n){r="#f00"}),g=t(),v=t().add(function(n){r=i}),x=t(),y=function(){p=!p},L=function(n){},b=function(){},w=function(n){n.setAttribute("stroke",i),n.setAttribute("stroke-width",s),n.setAttribute("fill",o)},k=function(){if(f){var n=document.createElementNS("http://www.w3.org/2000/svg","text");n.setAttribute("font-family","Verdana"),n.setAttribute("font-size","12px"),n.setAttribute("fill",i);var t=e.getLabelLocation();return n.setAttribute("x",t.x+5),n.setAttribute("y",t.y-5),n.appendChild(document.createTextNode(f)),n}return null};this.expose({draw:function(n){!e.isAvailable()||p&&!S||h(n)},getNewShapeLogic:function(){return L(e.getSpecs())},isHidden:function(){return p},isAvailable:function(){return e.isAvailable()},contains:d,makeAvailable:function(n){e.makeAvailable(n)},onchangeavailability:function(n){e.onchangeavailability(n)},onmouseover:m,onmouseout:v,onclick:x,ondrag:g,onchange:function(n){e.onchange(n)},setName:function(n){a=n},toString:function(){return a},toConstructionString:function(){return e.toString()+(f?".{"+f+"}":"")+(p?"h":"")},getSpecs:function(){return e.getSpecs()},getChanger:function(){return e.changer},dragTo:function(n){g(n)},repositionPoint:function(n,t,o){return e.repositionPoint(n,t,o)},passesFilter:function(n){return e.passesFilter(n)},setSelected:function(n){l=n},hideUnhide:y,closestPointTo:function(n){return e.closestPointTo(n)},movePointAround:function(n){return e.movePointAround(n)},setLabel:function(n){f=n},getLabelLocation:function(){return e.getLabelLocation()},toSvg:function(){var n=b();return f&&n.push(k()),n}}),this.extend("arc",function(t){h=this.override(h,function(n){this(n);var t=e.getSpecs();if(!t.center)return n.beginPath(),n.moveTo(t.end1.x,t.end1.y),n.lineTo(t.end2.x,t.end2.y),n.closePath(),void n.stroke();var o=e.getAngles();n.beginPath(),n.arc(t.center.x,t.center.y,t.radius,o.from,o.to,!o.clockwise),n.stroke()}),a=n.name||"arc",L=function(n){return u.arc(n)},e=L(t),b=function(){var n=document.createElementNS("http://www.w3.org/2000/svg","path");w(n);var t=e.getSpecs(),o=e.getAngles(),i="M"+t.end1.x+" "+t.end1.y+" A "+t.radius+" "+t.radius+" 0 "+(t.innerDot>0?"0":"1")+" "+(o.clockwise?"1":"0")+" "+t.end2.x+" "+t.end2.y;return n.setAttribute("d",i),[n]}}),this.extend("circle",function(t){h=this.override(h,function(n){this(n);var t=e.getSpecs();n.beginPath(),n.arc(t.center.x,t.center.y,t.r,0,2*Math.PI),n.closePath(),n.stroke()}),a=n.name||"circle",L=function(n){return u.circle(n)},e=L(t),b=function(){var n=document.createElementNS("http://www.w3.org/2000/svg","circle");w(n);var t=e.getSpecs();return n.setAttribute("cx",t.center.x),n.setAttribute("cy",t.center.y),n.setAttribute("r",t.r),[n]}}),this.extend("line",function(t){h=this.override(h,function(n){this(n);var t=e.getSpecs();if(!t.p1.equals(t.p2)){var o=c(t.p1,t.p2);n.beginPath(),n.moveTo(o.p1.x,o.p1.y),n.lineTo(o.p2.x,o.p2.y),n.closePath(),n.stroke()}}),a=n.name||"line",L=function(n){return u.line(n)},e=L(t),b=function(){var n=e.getSpecs();if(!n.p1.equals(n.p2)){var t=c(n.p1,n.p2),o=document.createElementNS("http://www.w3.org/2000/svg","line");return w(o),o.setAttribute("x1",t.p1.x),o.setAttribute("y1",t.p1.y),o.setAttribute("x2",t.p2.x),o.setAttribute("y2",t.p2.y),[o]}}}),this.extend("segment",function(t){h=this.override(h,function(n){this(n);var t=e.getSpecs();t.p1.equals(t.p2)||(n.beginPath(),n.moveTo(t.p1.x,t.p1.y),n.lineTo(t.p2.x,t.p2.y),n.closePath(),n.stroke())}),a=n.name||"segment",L=function(n){return u.segment(n)},e=L(t),b=function(){var n=e.getSpecs();if(!n.p1.equals(n.p2)){var t=document.createElementNS("http://www.w3.org/2000/svg","line");return w(t),t.setAttribute("x1",n.p1.x),t.setAttribute("y1",n.p1.y),t.setAttribute("x2",n.p2.x),t.setAttribute("y2",n.p2.y),[t]}}}),this.extend("point",function(t){h=this.override(h,function(n){this(n);var t=e.getSpecs();n.fillStyle=n.strokeStyle,n.strokeStyle="transparent",n.beginPath(),n.arc(t.location.x,t.location.y,2*s,0,2*Math.PI),n.closePath(),n.fill()}),a=n.name||"point",L=function(n){return u.point(n)},e=L(t),b=function(){var n=document.createElementNS("http://www.w3.org/2000/svg","circle");n.setAttribute("stroke","transparent"),n.setAttribute("fill",i);var t=e.getSpecs();return n.setAttribute("cx",t.location.x),n.setAttribute("cy",t.location.y),n.setAttribute("r",2*s),[n]}}),this.extend("locus",function(t){h=this.override(h,function(n){this(n),e.getSpecs().pointSets.map(function(t){n.beginPath(),t.map(function(t,e){0==e?n.moveTo(t.x,t.y):n.lineTo(t.x,t.y)}),n.stroke()})}),a=n.name||"point",L=function(n){return u.locus(n)},e=L(t),b=function(){return e.getSpecs().pointSets.map(function(n){var t=document.createElementNS("http://www.w3.org/2000/svg","path");w(t);for(var e="",o=0;o<n.length;o++)e+=0==o?"M "+n[o].x+" "+n[o].y:" L "+n[o].x+" "+n[o].y;return t.setAttribute("d",e),t})}})}),b=i(),w=[],k=[],P=e([],function(n){var e,o=t();return k.map(function(n){o.add(n(function(){return e}))}),n.onchange(d),e={remove:function(){var t=w.indexOf(n);-1!=t&&(w.splice(t,1),b.removeForShape(n),P.removeFor(n),o(),T())},makeAvailable:function(t){n.makeAvailable(t)},onmouseover:function(t){n.onmouseover.add(t)},onmouseout:function(t){n.onmouseout.add(t)},onclick:function(t){n.onclick.add(t)},onchange:function(t){n.onchange(t)},onchangeavailability:function(t){n.onchangeavailability(t)},ondrag:function(t){n.ondrag.add(t)},onremove:function(n){o.add(n)},dragTo:function(t){n.dragTo(t)},getChanger:n.getChanger,getSpecs:n.getSpecs,exclude:function(t){n.toBeExcludedFromMouseEvents=t},closestPointTo:n.closestPointTo,repositionPoint:n.repositionPoint,hideUnhide:n.hideUnhide,getNewShapeLogic:n.getNewShapeLogic,toString:n.toString,passesFilter:n.passesFilter,movePointAround:n.movePointAround,setLabel:n.setLabel,getLabelLocation:n.getLabelLocation,toConstructionString:n.toConstructionString}}),A=e([],function(n){return{s1:C(n.s1),s2:C(n.s2),calculate:n.calculate,toConstructionString:function(t){var e=n.calculate();return"intersection("+t(this.s1)+","+t(this.s2)+","+(e?e.toString():n.id.toString())+")"},toString:function(){return"intersection"}}}),C=function(n){return P.copyOf(n)},F=function(n){return P.originalOf(n)},E=function(n,t,e){return A.addFor(b.getForShapes(F(n),F(t),e))},N=function(n,t,e){return A.addFor(b.getForShapesAndId(F(n),F(t),e))},T=r(function(){p.width=f,w.map(function(n){n.draw(a)}),y.draw(a),h()},10),M=function(n,t){},I=function(n,t){},O=function(n,t){},R=function(n){},B=function(n,t,e){},U=function(n,t){},q=function(n){},X=function(n){},Y=function(n,t){w.map(function(t){b.makeForShapes([n,t])}),n.toBeExcludedFromMouseEvents=t||!1,w.push(n),w.sort(function(){var n=function(n){return n.passesFilter(o.POINT)?1:0};return function(t,e){return n(t)-n(e)}}());var e=P.addFor(n);return T(),e},G=function(){var n=document.createElementNS("http://www.w3.org/2000/svg","svg");return n.setAttribute("width",f),n.setAttribute("height",l),n.setAttribute("xmlns","http://www.w3.org/2000/svg"),w.map(function(t){if(t.isAvailable()&&!t.isHidden()){var e=t.toSvg();e&&e.length&&e.map(function(t){n.appendChild(t)})}}),n},H=function(){var n=[],t=function(t){var e=F(t);e.setSelected(!0),n.push(e)},e=function(){n.map(function(n){n.setSelected(!1)}),n=[]};return{addShape:t,clear:e,removeAll:function(){n.map(function(n){C(n).remove()}),e()}}}(),j=function(){for(var n;(n=P.allCopies()).length>0;)n[0].remove();v()},V=function(n,t,e,i,r){return n=n||function(){},t=t||function(){},e=e||function(){},i=i||function(){},function(u){y.setVisible(!1);var c,a,f=[];w.map(function(n){!n.toBeExcludedFromMouseEvents&&n.isAvailable()&&(!n.isHidden()||S)&&n.passesFilter(x)&&n.contains(s(u.clientX,u.clientY))?f.push(n):t(n,u)}),0==f.length?e(u):(y.setPosition(u.clientX,u.clientY),y.setVisible(!0),y.setText(""),c=f.filter(function(n){return n.passesFilter(o.POINT)}),c.length>0?n(c[c.length-1],u):1==f.length?n(f[f.length-1],u):(a=b.getForShapes(f[f.length-2],f[f.length-1],s(u.clientX,u.clientY)),a?i(function(n){return A.addFor(n)}(a),u):n(f[f.length-1],u))),r&&T()}},D={abouttograb:function(){p.style.cursor="-webkit-grab"},grabbing:function(){p.style.cursor="-webkit-grabbing"},none:function(){p.style.cursor="default"},pointer:function(){p.style.cursor="pointer"}},W=D.none,_=D.none,z=function(n,t){var e=typeof t;return"string"===e?t:"function"===e?t(n):""},$=V(function(n,t){W(),n.onmouseover(t);var e="",o=C(n);M(o,t,function(n){e=z(o,n)}),y.setText(e)},function(n,t){n.onmouseout(t)},function(n){_(),R(n)},function(n,t){var e="";B(n,t,function(t){e=z(n,t)}),y.setText(e)},!0),J=V(function(n,t){O(C(n),t)}),K=V(function(n,t){n.onclick(t),I(C(n),t)},function(n,t){n.onmouseout(t)},function(n){X(n)},function(n,t){U(n,t)});return p.addEventListener("mousemove",$),p.addEventListener("mousedown",function(n){g(n),J(n)}),p.addEventListener("mouseup",function(n){q(n),m(n),T()}),p.addEventListener("click",K),{newShapeOnRemove:function(n){k.push(n)},addCircle:function(n,t){return Y(L.circle({stroke:"#d66"},n),t)},addArc:function(n,t){return Y(L.arc({stroke:"#d6d"},n),t)},addPoint:function(n,t){return Y(L.point({stroke:"#66d"},n),t)},addLine:function(n,t){return Y(L.line({stroke:"#6d6"},n),t)},addLocus:function(n,t){return Y(L.locus({stroke:"#dd6"},n),t)},addSegment:function(n,t){return Y(L.segment({stroke:"#d6d"},n),t)},onmouseovershape:function(n){M=n||function(){}},onmousedownonshape:function(n){O=n||function(){}},onmouseovernotshape:function(n){R=n||function(){}},clear:j,ondraw:function(n){h.add(n)},onclear:function(n){v.add(n)},onshapechange:function(n){d.add(n)},getIntersectionForShapesAndPoint:E,getIntersectionForShapesAndId:N,onmouseoverintersection:function(n){B=n||function(){}},onclickintersection:function(n){U=n||function(){}},onclickshape:function(n){I=n||function(){}},onclicknotshape:function(n){X=n||function(){}},onmouseupSingle:function(n){q=n||function(){}},onmouseup:function(n){m.add(n)},onmousedown:function(n){g.add(n)},setMouseFilter:function(n){x=n},selectShape:function(n){H.addShape(n)},clearSelection:function(){H.clear()},removeSelection:function(){H.removeAll()},showHidden:function(){S=!0},hideHidden:function(){S=!1},setShapeCursor:function(n){W=n},setNoShapeCursor:function(n){_=n},cursor:D,toSvg:G}}(0,t,e,o,r,u,c,s,i),f="-?\\d+(?:\\.\\d+)?(?:e-?\\d+)?",l=function(n){var t=n.slice(),e=function(t){-1==n.indexOf(t)&&n.push(t)};return n.splice(0,n.length),t.map(function(n){e(n)}),{arr:n,push:e}},p=function(n,t,e,o,i,r){var u,c=[],s=function(n,t,e){var o=function(n){return t+"("+e.map(n).join(",")+")"};return{f:n,name:t,args:e,apply:function(){n.apply(null,e)},toString:o}},a=function(n,t,e){c.push(s(n,t,e))},f=function(n){u=n;for(var t in n)n.hasOwnProperty(t)&&(n[t]=function(t,e){return function(){a(t,e,Array.prototype.slice.apply(arguments)),t.apply(n,arguments)}}(n[t],t))},l=function(){var n=i([]);c.map(function(t){t.args.map(function(t){n.push(t)})});var t=e(n.arr,function(n,t){return t.toString()});return c.map(function(n){return n.toString(t.copyOf)}).join("")+";["+n.arr.map(function(n){return n.toConstructionString(t.copyOf)}).join(";")+";]"},p=[{level:0,matches:function(n){return"point"==n},make:function(t,e,i){return console.log(e),function(){var u=t.match(new RegExp("("+o+"),("+o+")")),c=r(parseFloat(u[1]),parseFloat(u[2]));return c=n.addPoint({location:c}),e&&c.setLabel(e),i&&c.hideUnhide(),c}}},{level:0,matches:function(n){return"arc"==n},make:function(t,e,i){return function(){var u=t.match(new RegExp("\\(("+o+"),("+o+")\\),\\(("+o+"),("+o+")\\),\\(("+o+"),("+o+")\\)")),c=n.addArc({end1:r(parseFloat(u[1]),parseFloat(u[2])),middle:r(parseFloat(u[3]),parseFloat(u[4])),end2:r(parseFloat(u[5]),parseFloat(u[6]))});return e&&c.setLabel(e),i&&c.hideUnhide(),c}}},{level:0,matches:function(n){return"circle"==n},make:function(t,e,i){return function(){var u=t.match(new RegExp("\\(("+o+"),("+o+")\\),("+o+")")),c=n.addCircle({center:r(parseFloat(u[1]),parseFloat(u[2])),r:parseFloat(u[3])});return e&&c.setLabel(e),i&&c.hideUnhide(),c}}},{level:0,matches:function(n){return"line"==n},make:function(t,e,i){return function(){var u=t.match(new RegExp("\\(("+o+"),("+o+")\\),\\(("+o+"),("+o+")\\)")),c=n.addLine({p1:r(parseFloat(u[1]),parseFloat(u[2])),p2:r(parseFloat(u[3]),parseFloat(u[4]))});return e&&c.setLabel(e),i&&c.hideUnhide(),c}}},{level:0,matches:function(n){return"segment"==n},make:function(t,e,i){return function(){var u=t.match(new RegExp("\\(("+o+"),("+o+")\\),\\(("+o+"),("+o+")\\)")),c=n.addSegment({p1:r(parseFloat(u[1]),parseFloat(u[2])),p2:r(parseFloat(u[3]),parseFloat(u[4]))});return e&&c.setLabel(e),i&&c.hideUnhide(),c}}},{level:1,matches:function(n){return"intersection"==n},make:function(t){return function(e){var i,u=t.match(new RegExp("(\\d+),(\\d+),\\(("+o+"),("+o+")\\)"));return u?n.getIntersectionForShapesAndPoint(e(u[1]),e(u[2]),r(parseFloat(u[3]),parseFloat(u[4]))):(i=t.match(new RegExp("(\\d+),(\\d+),(\\d+)")),n.getIntersectionForShapesAndId(e(i[1]),e(i[2]),parseInt(i[3])))}}},{level:0,matches:function(n){return"locus"==n},make:function(t,e,o){return function(){return n.addLocus({})}}}],h=function(n){var t=n.match(/^((?:\w+\([^)]+\))+);\[([^\]]+)\]$/);if(t){var e=t[1].match(/\w+\([^)]+\)(?:\.\{[^}]+\})?/g),o=t[2].match(/.*?;/g),r=o.map(function(n){var t=n.match(/(\w+)\((.*)\)(?:\.\{([^}]+)\})?(h)?;/),e=p.filter(function(n){return n.matches(t[1])})[0];return{level:e.level,make:e.make(t[2],t[3],t[4])}}),c=Array.apply(null,new Array(o.length)),s=function(n){return c[n]};i(r.map(function(n){return n.level})).arr.sort(function(n,t){return n-t}).map(function(n){r.filter(function(t){return t.level==n}).map(function(n){c[r.indexOf(n)]=n.make(s)})}),e.map(function(n){var t=n.match(/(\w+)\(([^)]+)\)/),e=t[1],o=t[2].match(/\d+/g).map(function(n){return c[parseInt(n)]});u[e].apply(null,o)})}},d=function(n){c=c.filter(function(t){return!t.args.some(function(t){return t==n})})};return n.newShapeOnRemove(function(n){return function(){d(n())}}),{addCall:a,register:f,toString:l,backFromString:h,removeCallsWithArgument:d}}(a,0,e,f,l,i),h=function(n,t,e,o,i,r,u){var c,s=[],a=[],f=function(n){return s.filter(function(t){return t.dependent==n})},l=function(n){return f(n).length>0||h(n).length>0},p=function(n){return!l(n)||0==h(n).length&&!f(n).some(function(n){return 0==n.freedom})},h=function(n){return a.filter(function(t){return t.p==n})},d=function(n,t){return t=t||i([n]),f(n).map(function(n){t.push(n.independent),d(n.independent,t)}),h(n).map(function(n){t.push(n.s1),t.push(n.s2),d(n.s1,t),d(n.s2,t)}),t.arr},m=function(n,t){return t=t||i([]),f(n).map(function(n){t.push(n),m(n.independent,t)}),h(n).map(function(n){t.push(n),m(n.s1,t),m(n.s2,t)}),t.arr},g=function(n,t,e,o,i){return{dependent:n,independent:t,howToChange:e,constants:o,freedom:i,apply:function(){t.onchange(function(i,r){e(i,r,n.getChanger(),o?o.map(function(n){return n.getSpecs()}):[],n,t)}),c(n,[t])},clone:function(r,u){return g(r(n),r(t),e,o?o.map(r):[],i)}}},v=function(n,t,e,o){return{s1:t,s2:e,p:n,apply:function(){var t=function(){var t=o.calculate();t?(n.makeAvailable(!0),n.getChanger().setLocation(t)):n.makeAvailable(!1)};c(n,[o.s1,o.s2]),o.s1.onchange(t),o.s2.onchange(t),t()},clone:function(o,i){return v(o(n),o(t),o(e),i(o(t),o(e),o(n).getSpecs().location))}}},S=function(n){return f(n)[0].independent.movePointAround(n.getSpecs().location)};c=function(n,t){t.map(function(t){t.onremove&&t.onremove(function(){n.remove()}),t.onchangeavailability(function(t){n.makeAvailable(t)})})};var x=function(n,t,e,o,i){i=i||0;var r=g(n,t,e,o,i);s.push(r),r.apply()},y=function(n,t,e,o){var i=v(n,t,e,o);a.push(i),i.apply()},L={point:function(n,t){var e;return t?(e=function(e){n.getChanger().setLocation(t.closestPointTo(e))},n.ondrag(e),e(n.getSpecs().location),x(n,t,function(n,t,e,o,i,r){var u=i.getSpecs().location,c=r.repositionPoint(u,n,t)||r.closestPointTo(u);e.setLocation(c)},null,1)):n.ondrag(function(t){n.getChanger().setLocation(t)}),{onchange:function(t){n.onchange(t)}}},pointOnIntersection:function(n,t){y(n,t.s1,t.s2,t)},arc:function(n,t,e,o){x(o,n,function(n,t,e){e.setEnd1(t.location)},null,0),x(o,t,function(n,t,e){e.setEnd2(t.location)},null,0),x(o,e,function(n,t,e){e.setMiddle(t.location)},null,0)},circle:function(n,t,e){e?(x(t,e,function(n,t,e,o){e.together(function(){this.setCenter(o[0].location),this.setR(t.location.minus(o[0].location).mod())})},[n],0),x(t,n,function(n,t,e,o){e.together(function(){this.setCenter(t.location),this.setR(t.location.minus(o[0].location).mod())})},[e],0)):(x(t,n,function(n,t,e){e.setCenter(t.location)},null,1),t.ondrag(function(n){var e=t.getSpecs().center;t.getChanger().setR(e.minus(n).mod())}))},line:function(n,t,e){if(e){var o=t.getChanger();o.setP1(n.getSpecs().location),o.setP2(e.getSpecs().location),x(t,e,function(n,t,e){e.setP2(t.location)},null,0),x(t,n,function(n,t,e){e.setP1(t.location)},null,0)}else t.ondrag(function(n){t.getChanger().moveTo(n)}),x(t,n,function(n,t,e){var o=t.location.minus(n.location);e.translateBy(o)},null,1)},segment:function(n,t,e){x(t,e,function(n,t,e){e.setP2(t.location)},null,0),x(t,n,function(n,t,e){e.setP1(t.location)},null,0)},perpendicularLine:function(n,t,e){x(t,n,function(n,t,e){e.translateBy(t.location.minus(n.location))},null,0),x(t,e,function(n,t,e){e.setFromP1(t.p2.minus(t.p1).matrix(0,-1,1,0))},null,0)},parallelLine:function(n,t,e){x(t,n,function(n,t,e){e.translateBy(t.location.minus(n.location))},null,0),x(t,e,function(n,t,e){e.setFromP1(t.p2.minus(t.p1))},null,0)},perpendicularBisector:function(n,t,e){x(t,n,function(n,t,e,o){e.together(function(){this.setP1(t.location.plus(o[0].location).scale(.5)),this.setFromP1(o[0].location.minus(t.location).matrix(0,-1,1,0))})},[e],0),x(t,e,function(n,t,e,o){e.together(function(){this.setP1(o[0].location.plus(t.location).scale(.5)),this.setFromP1(t.location.minus(o[0].location).matrix(0,-1,1,0))})},[n],0)},pointLineReflection:function(t,e,o){x(o,e,function(t,e,o,i){o.setLocation(n.reflectPointInLine(e.p1,e.p2,i[0].location))},[t],0),x(o,t,function(t,e,o,i){o.setLocation(n.reflectPointInLine(i[0].p1,i[0].p2,e.location))},[e],0)},locus:function(n,o,i){var c=d(n);if(c.filter(function(n){return p(n)}).some(function(n){return n==i})&&l(i)){console.log("ok");var s=m(n),a=t(),f=e(c,function(n){return n.getNewShapeLogic()});a.makeForShapes(f.allCopies()),s.map(function(n){n.clone(f.copyOf,a.getForShapes).apply()});var h=f.copyOf(n),g=f.copyOf(i),v=function(){var n=r();return c.map(function(t){var e=f.copyOf(t);n.add(function(){e.getChanger().useSpecs(t.getSpecs())})}),n}(),x=u(function(){console.log("create points");var n=S(i),t=[],e=[];t.push(e),n.map(function(n){g.getChanger().setLocation(n),h.isAvailable()?e.push(h.getSpecs().location):(e=[],t.push(e))}),o.getChanger().setPointSets(t)},10,!0);n.onchange(function(n,t){v(),x()}),n.onremove(function(){o.remove()}),o.onremove(function(){x=function(){}}),x()}else console.log("not ok")},midpoint:function(n,t,e){x(t,n,function(n,t,e,o){e.setLocation(t.location.plus(o[0].location).scale(.5))
},[e],0),x(t,e,function(n,t,e,o){e.setLocation(t.location.plus(o[0].location).scale(.5))},[n],0)},angleBisector:function(t,e,o,i){x(i,t,function(t,e,o,i){o.together(function(){this.setP1(i[0].location),this.setP2(n.getPointOnAngleBisector(e.location,i[0].location,i[1].location))})},[e,o],0),x(i,e,function(t,e,o,i){o.together(function(){this.setP1(e.location),this.setP2(n.getPointOnAngleBisector(i[0].location,e.location,i[1].location))})},[t,o],0),x(i,o,function(t,e,o,i){o.together(function(){this.setP1(i[1].location),this.setP2(n.getPointOnAngleBisector(i[0].location,i[1].location,e.location))})},[t,e],0)}};return o.register(L),L}(n,r,e,p,l,t,u),d=function(n,t,e,o,i){var r=function(e,o,r){n.setMouseFilter(t.POINT),n.setShapeCursor(n.cursor.pointer),n.onmouseovernotshape(function(n){o(i(n.clientX,n.clientY))}),n.onmouseovershape(function(n,t,e){e(r),o(n.closestPointTo(i(t.clientX,t.clientY)))}),n.onclicknotshape(function(n){e(i(n.clientX,n.clientY))}),n.onclickshape(function(n,t){e(n.closestPointTo(i(t.clientX,t.clientY)),n)})},u=function(e,o,r){n.setMouseFilter(t.NOT_LOCUS),n.setShapeCursor(n.cursor.none),n.setNoShapeCursor(n.cursor.none),n.onmousedownonshape(),n.onmouseovernotshape(function(n){o(i(n.clientX,n.clientY))}),n.onmouseovershape(function(n,t,e){e(r),o(n.closestPointTo(i(t.clientX,t.clientY)))}),n.onmouseoverintersection(function(n,t,e){e(r),o(n.calculate())}),n.onclicknotshape(function(n){e(i(n.clientX,n.clientY))}),n.onclickshape(function(n,t){e(n.closestPointTo(i(t.clientX,t.clientY)),n)}),n.onclickintersection(function(n){e(null,null,n)})},c=function(e,o,r){o=o||function(){},n.setMouseFilter(t.POINT),n.setShapeCursor(n.cursor.pointer),n.setNoShapeCursor(n.cursor.none),n.onmousedownonshape(),n.onclickshape(function(n,t){e(n)}),n.onmouseovernotshape(function(n){o(i(n.clientX,n.clientY))}),n.onmouseovershape(function(n,t,e){e(r),o(n.closestPointTo(i(t.clientX,t.clientY)))})},s=function(e,o,i){o=o||t.ALL,n.setMouseFilter(o),n.setShapeCursor(n.cursor.pointer),n.setNoShapeCursor(n.cursor.none),n.onmousedownonshape(),n.onmouseovershape(function(n,t,e){e(i)}),n.onmouseovernotshape(),n.onclickshape(function(n,t){e(n)})},a={doNothing:function(){n.setMouseFilter(t.ALL),n.setShapeCursor(n.cursor.abouttograb),n.setNoShapeCursor(n.cursor.none),n.onclickshape(),n.onclicknotshape(),n.onmousedownonshape(a.startMoving),n.onmouseovershape(),n.onmouseoverintersection(),n.onclickintersection(),n.onmouseovernotshape(),n.onmouseupSingle()},select:function(e){return n.setMouseFilter(t.ALL),n.onmousedownonshape(),n.setNoShapeCursor(n.cursor.none),n.setShapeCursor(n.cursor.none),n.onclickshape(function(t,e){n.selectShape(t)}),n.onclicknotshape(function(t){n.clearSelection()}),function(){n.clearSelection(),e()}},hideUnhide:function(e){return n.showHidden(),n.setMouseFilter(t.ALL),n.onmousedownonshape(),n.setNoShapeCursor(n.cursor.none),n.setShapeCursor(n.cursor.none),n.onclicknotshape(),n.onclickshape(function(n,t){n.hideUnhide()}),function(){n.hideHidden(),e()}},startMoving:function(t,e){n.setShapeCursor(n.cursor.grabbing),n.setNoShapeCursor(n.cursor.grabbing);var o=function(n){t.dragTo(i(n.clientX,n.clientY))};n.onmouseupSingle(a.doNothing),n.onmouseovershape(function(n,t){o(t)}),n.onmouseovernotshape(o),n.onmouseoverintersection(function(n,t){o(t)}),o(e)},makePointStructure:function(t,e){var r=n.addPoint({location:i(200,200)},!0);return u(function(n,i,u){t(u?o.pointOnIntersection(r,u):i?o.point(r,i):o.point(r)),r.exclude(!1),e()},function(n){r.getChanger().setLocation(n)},function(n){return"on this "+n.toString()}),function(){r.remove(),e()}},makeCircleStructure:function(t,e){var i,u,s,a=e;return c(function(c){i=c,s=n.addCircle({center:i.getSpecs().location,r:20}),u=function(n){s.getChanger().setR(n.minus(i.getSpecs().location).mod())},r(function(n,r){r?(t(o.circle(i,s,r)),e()):(t(o.circle(i,s)),e())},function(n){u(n)},"this circumference point"),a=function(){s.remove(),e()}},function(){},"center here"),function(){a()}},makeArcStructure:function(t,e){var i;return c(function(r){i=n.addSegment({p1:r.getSpecs().location,p2:r.getSpecs().location}),c(function(u){var s=r.getSpecs().location,a=u.getSpecs().location;i.remove(),i=n.addArc({end1:s,end2:a,middle:a}),c(function(n){t(o.arc(r,n,u,i)),e()},function(n){i.getChanger().setEnd2(n)},"end2 here")},function(n){i.getChanger().setP2(n)},"middle here")},function(){},"end1 here"),e},makeLineStructure:function(t,e){var u,s,a,f=e;return c(function(c){u=c,a=n.addLine({p1:u.getSpecs().location,p2:u.getSpecs().location.plus(i(100,0))}),s=function(n){a.getChanger().moveTo(n)},r(function(n,i){i?(t(o.line(u,a,i)),e()):(t(o.line(u,a)),e())},function(n){s(n)},"...and this point"),f=function(){a.remove(),e()}},function(){},"through this point..."),function(){f()}},makeSegmentStructure:function(t,e){var r,u,s=e;return c(function(a){u=n.addSegment({p1:a.getSpecs().location,p2:a.getSpecs().location.plus(i(100,0))}),r=function(n){u.getChanger().setP2(n)},c(function(n){t(o.segment(a,u,n)),e()},function(n){r(n)},"...to this point"),s=function(){u.remove(),e()}},function(){},"from this point..."),function(){s()}},makePerpendicularLine:function(e,i){var r,u=i;return c(function(u){r=u,s(function(t){var u=t.getSpecs(),c=r.getSpecs().location,s=c.plus(u.p2.minus(u.p1).matrix(0,-1,1,0)),a=n.addLine({p1:c,p2:s});e(o.perpendicularLine(r,a,t)),i()},t.LINE|t.SEGMENT,function(n){return"perpendicular to this "+n.toString()})},function(){},"through this point"),function(){u()}},makeParellelLine:function(e,i){var r,u=i;return c(function(u){r=u,s(function(t){var u=t.getSpecs(),c=r.getSpecs().location,s=c.plus(u.p2.minus(u.p1)),a=n.addLine({p1:c,p2:s});e(o.parallelLine(r,a,t)),i()},t.LINE|t.SEGMENT,function(n){return"...parallel to this "+n.toString()})},function(){},"through this point..."),function(){u()}},makePerpendicularBisector:function(t,e){var i=e;return c(function(i){c(function(r){var u=i.getSpecs().location,c=r.getSpecs().location,s=u.plus(c).scale(.5),a=n.addLine({p1:s,p2:s.plus(c.minus(u).matrix(0,-1,1,0))});t(o.perpendicularBisector(i,a,r)),e()},function(){},"...and this point")},function(){},"between this point..."),function(){i()}},makeLocus:function(t,e){return c(function(i){c(function(r){t(o.locus(i,n.addLocus({}),r)),e()},function(){},"...with respect to this point")},function(){},"the locus of this point..."),e},makePointLineReflection:function(i,r){return c(function(u){s(function(t){var c=t.getSpecs(),s=n.addPoint({location:e.reflectPointInLine(c.p1,c.p2,u.getSpecs().location)});i(o.pointLineReflection(u,t,s)),r()},t.LINE|t.SEGMENT,function(n){return"...with respect to this "+n.toString()})},function(){},"reflect this point"),r},makeMidpoint:function(t,e){return c(function(i){c(function(r){var u=n.addPoint({location:i.getSpecs().location.plus(r.getSpecs().location).scale(.5)});t(o.midpoint(i,u,r)),e()},function(){},"...and this point")},function(){},"the point between this point..."),e},makeAngleBisector:function(t,i){return c(function(r){c(function(u){c(function(c){var s=r.getSpecs().location,a=u.getSpecs().location,f=c.getSpecs().location,l=e.getPointOnAngleBisector(s,a,f),p=n.addLine({p1:a,p2:l});t(o.angleBisector(r,u,c,p)),i()},function(){},"...this point.")},function(){},", this point, and...")},function(){},"bisect angle defined by this point, ..."),i},setLabel:function(n,t){var e=t;return s(function(o){var i=o.getLabelLocation();requireElement("<input type='text' style='width:30px;position:absolute;left:"+(i.x+5)+"px;top:"+(i.y-15)+"px' id='1'>",function(i){var r=function(){document.body.removeChild(i)};document.body.appendChild(i),i.focus(),i.addEventListener("blur",function(){o.setLabel(i.value),r(),n(),t()}),e=function(){r(),t()}})}),function(){e()}}};return a}(a,o,n,h,i),m=function(n,t,e){var o=function(n){var e=new RegExp("\\(("+t+","+t+")\\)","g");n=n.match(/([^\]]*)(\[[^\]]*\])/);var o=function(){var n=[];return function(t,e){var o=n.indexOf(e);return-1==o?(n.push(e),"("+e+")"):"("+o.toString()+")"}}();return n[1]+n[2].replace(e,o)},i=function(n){var e=new RegExp("\\(("+t+","+t+"|\\d+)\\)","g");n=n.match(/([^\]]*)(\[[^\]]*\])/);var o=function(){var n=[];return function(e,o){if(-1!=o.indexOf(",")){var i=o.match(new RegExp(t+","+t))[0];return n.push(i),"("+i+")"}return"("+n[parseInt(o.match(/\d+/)[0])]+")"}}();return n[1]+n[2].replace(e,o)},r=function(){var t,e=window.location.hash.substr(1);e&&(t=i(decodeURI(e)),n.backFromString(t),u.push(t))},u=function(){var n=[];return window.states=n,{push:function(t){t!=n[n.length-1]&&n.push(t)},nextToLast:function(){if(n.length>1)return n.splice(n.length-1,1),n[n.length-1]}}}();return{write:function(){console.log("writing state");var t=n.toString();window.location.hash=encodeURI(o(t)),u.push(t)},nextToLast:function(){var t=u.nextToLast();t&&(e.clear(),n.backFromString(t),window.location.hash=encodeURI(o(t)))},read:r}}(p,f,a),function(n,t,e){var o=function(){var n=function(){var n=20,t=20;return{next:function(){var e={x:n,y:t};return n+=40,n>=300&&(n=20,t+=40),e}}},t=n(),e=n(),o=function(n,t){n.setAttribute("class",n.getAttribute("class")+" "+t)},i=function(n,t){n.setAttribute("class",n.getAttribute("class").split(/[\s]+/g).filter(function(n){return n!=t}).join(" "))};return function(n,r,u){var c=(u?e:t).next();requireElement("<div id='1' class='button"+(r?" "+r:"")+"' style='"+(u?"right:"+c.x+"px":"left:"+c.x+"px")+";top:"+c.y+"px'></div>",function(t){var e=function(){o(t,"active")},r=function(){i(t,"active")},u=function(o){var i;o.preventDefault(),e(),(i=n(function(){r(),t.onclick=u}))&&(t.onclick=function(){i(),r(),t.onclick=u})};t.onclick=u,document.body.appendChild(t)})}}();o(function(n){return t.makePointStructure(function(n){},function(){t.doNothing(),e.write(),n()})},"point"),o(function(n){return t.makeCircleStructure(function(){},function(){t.doNothing(),e.write(),n()})},"circle"),o(function(n){return t.makeArcStructure(function(){},function(){t.doNothing(),e.write(),n()})},"arc"),o(function(n){return t.makeLineStructure(function(){},function(){t.doNothing(),e.write(),n()})},"line"),o(function(n){return t.makeSegmentStructure(function(){},function(){t.doNothing(),e.write(),n()})},"segment"),o(function(n){return t.makePerpendicularLine(function(){},function(){t.doNothing(),e.write(),n()})},"perpendicular"),o(function(n){return t.makeParellelLine(function(){},function(){t.doNothing(),e.write(),n()})},"parallel"),o(function(n){return t.makePerpendicularBisector(function(){},function(){t.doNothing(),e.write(),n()})},"bisect"),o(function(n){return t.makePointLineReflection(function(){},function(){t.doNothing(),e.write(),n()})},"reflect-line"),o(function(n){return t.makeMidpoint(function(){},function(){t.doNothing(),e.write(),n()})},"midpoint"),o(function(n){return t.makeLocus(function(){},function(){t.doNothing(),e.write(),n()})},"locus"),o(function(n){return t.makeAngleBisector(function(){},function(){t.doNothing(),e.write(),n()})},"angle-bisector"),o(function(n){return t.setLabel(function(){},function(){t.doNothing(),n(),e.write()})},"label"),o(function(n){return t.select(function(){t.doNothing(),n()})},"select",!0),o(function(n){return t.hideUnhide(function(){t.doNothing(),n()})},"hide",!0),o(function(t){n.removeSelection(),t(),e.write()},"remove",!0),o(function(t){requireElement('<div style="position:absolute;left:0px;top:0px;width:100%;height:100%;background-color:#fff" id="1"/>',function(t){t.appendChild(n.toSvg()),document.body.innerHTML="",document.body.appendChild(t)}),t()},"svg",!0),o(function(t){n.clear(),e.write(),t()},"clear",!0),o(function(n){e.nextToLast(),n()},"undo",!0)}(a,d,m),function(){Array.prototype.lastMin=function(n){for(var t,e,o=1/0,i=0;i<this.length;i++)(e=n(this[i]))<=o&&(o=e,t=this[i]);return t}}(),function(n,t,e,o){n.onmouseup(function(){console.log("mouseup"),e.write()}),e.read(),t.doNothing()}(a,d,m)}();